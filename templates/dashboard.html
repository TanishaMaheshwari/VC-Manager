{% extends "base.html" %}

{% block title %}Dashboard - VC Manager{% endblock %}

{% block content %}
<!-- <div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 fw-bold text-center mb-4" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            <i class="fas fa-tachometer-alt me-3"></i>VC Committee Dashboard
        </h1>
    </div>
</div> -->

<div class="container-fluid">
    <div class="row">
        <!-- Payment Form Section -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill me-2"></i>Record Payment
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}

                        <!-- VC selection -->
                        <div class="mb-3">
                            {{ form.vc_id.label(class="form-label") }}
                            {{ form.vc_id(class="form-select", id="vc-select") }}
                            {% for error in form.vc_id.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <!-- Hand selection -->
                        <div class="mb-3">
                            {{ form.hand_id.label(class="form-label") }}
                            {{ form.hand_id(class="form-select", id="hand-select") }}
                            {% for error in form.hand_id.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text text-muted">
                                Select the hand. Each option shows Hand number, winner, and date.
                            </div>
                        </div>

                        <!-- Person selection -->
                        <div class="mb-3">
                            {{ form.person_id.label(class="form-label") }}
                            {{ form.person_id(class="form-select", id="person-select") }}
                            {% for error in form.person_id.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <!-- Date (defaults to today) -->
                        <div class="mb-3">
                            {{ form.date.label(class="form-label") }}
                            {# Render an HTML5 datetime-local input so browsers show date + HH:MM (no seconds)
                               WTForms DateTimeField is configured to use the matching format '%Y-%m-%dT%H:%M'. #}
                            {% set date_val = form.date.data.strftime('%Y-%m-%dT%H:%M') if form.date.data else '' %}
                            <input id="payment-date" name="{{ form.date.name }}" type="datetime-local" class="form-control" value="{{ date_val }}">
                            {% for error in form.date.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text text-muted">
                                Defaults to today, but editable.
                            </div>
                        </div>

                        <!-- Amount (auto-filled contribution) -->
                        <div class="mb-3">
                            {{ form.amount.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                {{ form.amount(class="form-control", id="payment-amount") }}
                            </div>
                            {% for error in form.amount.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            <div class="form-text text-muted">
                                Auto-filled with actual contribution per person for the selected hand.
                            </div>
                        </div>

                        <!-- Narration -->
                        <div class="mb-3">
                            {{ form.narration.label(class="form-label") }}
                            {{ form.narration(class="form-control", rows="3") }}
                            {% for error in form.narration.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-between flex-wrap gap-2">
                            <a href="{{ url_for('vc.vcs_list') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </a>
                            {{ form.submit(class="btn btn-success") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards Section -->
        <div class="col-lg-6 col-md-12">
            <div class="row">
                <!-- Total Due Card -->
                <div class="col-12 mb-3">
                    <div class="stat-card" onclick="showDueDetails()">
                        <div class="stat-number">₹{{ "%.0f"|format(total_due) }}</div>
                        <div class="stat-label">
                            <i class="fas fa-exclamation-triangle me-1"></i>Total Due
                        </div>
                        <small class="text-muted mt-2 d-block">
                            Click to view detailed breakdown by VC and person
                        </small>
                    </div>
                </div>
                
                <!-- Total VC Card -->
                <div class="col-12 mb-3">
                    <div class="stat-card" onclick="location.href='{{ url_for('vc.vcs_list') }}'">
                        <div class="stat-number">{{ total_vcs }}</div>
                        <div class="stat-label">
                            <i class="fas fa-building me-1"></i>Total VCs
                        </div>
                        <small class="text-muted mt-2 d-block">
                            Click to view all VC records and details
                        </small>
                    </div>
                </div>
                
                <!-- Total People Card -->
                <div class="col-12 mb-3">
                    <div class="stat-card" onclick="location.href='{{ url_for('person.persons') }}'">
                        <div class="stat-number">{{ total_persons }}</div>
                        <div class="stat-label">
                            <i class="fas fa-users me-1"></i>Total People
                        </div>
                        <small class="text-muted mt-2 d-block">
                            Click to manage person accounts and ledgers
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Section
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Recent Activity
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-plus-circle me-2 text-success"></i>Recent VCs
                        </h6>
                        {% for vc in vcs[:3] %}
                        <div class="d-flex align-items-center mb-2 p-2 rounded" style="background: var(--secondary-color);">
                            <div class="me-3">
                                <span class="badge bg-primary">{{ vc.vc_number }}</span>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">{{ vc.name }}</div>
                                <small class="text-muted">{{ vc.start_date.strftime('%d %b %Y') }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">₹{{ "%.0f"|format(vc.amount) }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-users me-2 text-info"></i>Active Members
                        </h6>
                        {% for person in persons[:3] %}
                        <div class="d-flex align-items-center mb-2 p-2 rounded" style="background: var(--secondary-color);">
                            <div class="me-3">
                                <div class="person-badge" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                                    {{ person.short_name }}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">{{ person.name }}</div>
                                <small class="text-muted">{{ person.email or 'No email' }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge {{ 'bg-success' if person.total_balance >= 0 else 'bg-danger' }}">
                                    ₹{{ "%.0f"|format(person.total_balance) }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!-- Due Details Modal -->
<div class="modal fade" id="dueDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 1rem; border: none;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none;">
                <h5 class="modal-title">
                    <i class="fas fa-chart-pie me-2"></i>Due Amount Breakdown
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="modern-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><i class="fas fa-building me-1"></i>VC Name</th>
                                <th><i class="fas fa-user me-1"></i>Person</th>
                                <th><i class="fas fa-dollar-sign me-1"></i>Due Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vc in vcs %}
                                {% if vc.total_due_per_vc > 0 %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary me-2">{{ vc.vc_number }}</span>
                                            {{ vc.name }}
                                        </td>
                                        <td>
                                            <div class="person-badge d-inline-block">
                                                {{ vc.hand_person.short_name if vc.hand_person else 'N/A' }}
                                            </div>
                                            {{ vc.hand_person.name if vc.hand_person else 'N/A' }}
                                        </td>
                                        <td>
                                            <span class="due-amount">₹{{ "%.2f"|format(vc.total_due_per_vc) }}</span>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showDueDetails() {
    new bootstrap.Modal(document.getElementById('dueDetailsModal')).show();
}
    document.addEventListener("DOMContentLoaded", () => {
        const vcSelect = document.getElementById("vc-select");
        const handSelect = document.getElementById("hand-select");
        const personSelect = document.getElementById("person-select");
        const amountInput = document.getElementById("payment-amount");

        // Load hands for a given VC
        async function loadHands(vcId) {
            if (!vcId) return;

            try {
                const res = await fetch(`/api/vc/${vcId}/details`);
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const data = await res.json();

                // Reset dropdowns
                handSelect.innerHTML = '<option value="">-- Select Hand --</option>';
                personSelect.innerHTML = '<option value="">-- Select Person --</option>';
                amountInput.value = "";

                // Only include hands that have a winner
                const handsWithWinner = data.hands.filter(h => h.winner_name && h.winner_name !== "Pending");
                handsWithWinner.forEach(h => {
                    const handDate = h.date ? new Date(h.date).toLocaleDateString() : 'N/A';
                    const opt = document.createElement("option");
                    opt.value = h.id;
                    opt.textContent = `Hand ${h.hand_number} - Winner: ${h.winner_name} - Date: ${handDate}`;
                    handSelect.appendChild(opt);
                });

                // Auto-select first hand if exists
                if (handSelect.options.length > 1) {
                    handSelect.selectedIndex = 1;
                    handSelect.dispatchEvent(new Event("change")); // triggers person loading
                }

            } catch (err) {
                console.error("Failed to load hands:", err);
            }
        }

        // Load persons and contribution amount for a given hand
        async function loadPersons(handId) {
            if (!handId) return;

            try {
                const res = await fetch(`/api/hand/${handId}/details`);
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const data = await res.json();

                // Reset persons and amount
                personSelect.innerHTML = '<option value="">-- Select Person --</option>';
                amountInput.value = "";

                // Populate persons dropdown
                data.pending_persons.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.textContent = p.name;
                    personSelect.appendChild(opt);
                });

                // Set contribution amount
                amountInput.value = data.contribution_amount || "";

            } catch (err) {
                console.error("Failed to load pending persons:", err);
            }
        }

        // When VC changes
        vcSelect.addEventListener("change", () => {
            const vcId = vcSelect.value;
            loadHands(vcId);
        });

        // When Hand changes
        handSelect.addEventListener("change", () => {
            const handId = handSelect.value;
            loadPersons(handId);
        });

        // Trigger load on page load: auto-select first pending VC and load its hands
        if (!vcSelect.value && vcSelect.options.length > 1) {
            vcSelect.selectedIndex = 1; // Select first pending VC
        }
        if (vcSelect.value) {
            loadHands(vcSelect.value);
        }
    });
</script>

{% endblock %}